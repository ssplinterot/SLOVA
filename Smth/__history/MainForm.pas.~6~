unit MainForm;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes,
  System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs,
  startGame, PlayersSelector, GameMenu, Help, FMX.Controls.Presentation,
  FMX.StdCtrls;

type
  TForm1 = class(TForm)
    Frame21: TFrame2;
    Frame31: TFrame3;
    Frame11: TPlayersFrame;
    GameFrame1: TGameFrame;
    procedure GameStart;
    procedure Frame21Button2Click(Sender: TObject);
    procedure Frame31Button2Click(Sender: TObject);
    procedure Frame11Button4Click(Sender: TObject);
    procedure Frame21Button1Click(Sender: TObject);
    procedure Frame11Button2Click(Sender: TObject);
    procedure Frame11Button1Click(Sender: TObject);
    procedure Frame11Button3Click(Sender: TObject);
    procedure GameFrame1Edit1KeyDown(Sender: TObject; var Key: Word;
      var KeyChar: WideChar; Shift: TShiftState);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

const
  DictSize = 1532629;

var
  Form1: TForm1;
  GameStarted: boolean;
  PlayerCount, WordCount, Max: integer;
  S, Source: string;
  Score, CurrScore: array [1 .. 4] of integer;
  Dictionary, UsedWords: array of string;
  Code: byte;

implementation

{$R *.fmx}

procedure GetDictionary(var Dictionary: array of string; Name: string);
var
  Txt: TextFile;
  i: integer;
begin
  AssignFile(Txt, Name);
  Reset(Txt);
  i := 0;
  while not EOF(Txt) do
  begin
    Readln(Txt, Dictionary[i]);
    Inc(i);
  end;
end;

function GetRandomWord(const Dictionary: array of string;
  MinLength: integer): string;
var
  Number, i: integer;
begin
  if MinLength < 30 then
  begin
    Number := Random(Length(Dictionary));
    if Number > Length(Dictionary) then
      i := -1
    else
      i := 1;
    while Length(Dictionary[Number]) < MinLength do
      Number := Number + i;
    result := Dictionary[Number];
  end
  else
    result := 'Нет-таких-больших-слов-кринжуля';
end;

function ChangeRegister(S: string): string;
begin
  for var i := 1 to Length(S) do
  begin
    if (S[i] >= 'А') and (S[i] <= 'Я') then
      S[i] := Chr(Ord(S[i]) + 32)
    else if (S[i] = 'ё') or (S[i] = 'Ё') then
      S[i] := 'е';

  end;
  result := S;
end;

procedure TForm1.GameFrame1Edit1KeyDown(Sender: TObject; var Key: Word;
  var KeyChar: WideChar; Shift: TShiftState);
begin
  if Key = vkReturn then
  begin
    S := GameFrame1.Edit1.Text;
    S := Trim(S);
    S := ChangeRegister(S);
    Code := 0;
    CurrScore[i] := GetScore(S, Source, UsedWords, WordCount, Code);
    Score[i] := Score[i] + CurrScore[i];
    case Code of
      0:
        Writeln('Игрок ', i, ' получает ', CurrScore[i], ' очков');
          // Коды: 0 - всё ок, 1 - пустая строка, 2 - слова не существует, 3 - повторка, 4 - изначальное, 5 - не те буквы
      1:
        Writeln('Игрок ', i, ' пропускает ход');
      2:
        Writeln('Игрок ', i, ' теряет ', -CurrScore[i],
          ' очков: такого слова не существует');
      3:
        Writeln('Игрок ', i, ' теряет ', -CurrScore[i],
          ' очков: это слово уже использовалось');
      4:
        Writeln('Игрок ', i, ' теряет ', -CurrScore[i],
          ' очков: это изначальное слово');
      5:
        Writeln('Игрок ', i, ' теряет ', -CurrScore[i],
          ' очков: слово содержит неправильные буквы: ', S);
    end;
  end;
end;

procedure TForm1.GameStart;
var
  i, j: integer;
begin
  SetLength(Dictionary, DictSize);
  GetDictionary(Dictionary, 'Dictionary.txt');
  Randomize;
  Source := GetRandomWord(Dictionary, 10);
  GameFrame1.SourceWord.Text := Source;
  Source := ChangeRegister(Source);
  SetLength(UsedWords, PlayerCount * Length(Source));
  UsedWords[0] := Source;
  WordCount := 1;
  for i := 1 to PlayerCount do
    CurrScore[i] := 1;
    {repeat
    i := 1;
    while (i <= PlayerCount) and not((CurrScore[1] = 0) and (CurrScore[2] = 0)
      and (CurrScore[3] = 0) and (CurrScore[4] = 0)) do
    begin
      S := Trim(S);
      S := ChangeRegister(S);
      Code := 0;
      CurrScore[i] := GetScore(S, Source, UsedWords, WordCount, Code);
      Score[i] := Score[i] + CurrScore[i];
      case Code of
        0:
          Writeln('Игрок ', i, ' получает ', CurrScore[i], ' очков');
          // Коды: 0 - всё ок, 1 - пустая строка, 2 - слова не существует, 3 - повторка, 4 - изначальное, 5 - не те буквы
        1:
          Writeln('Игрок ', i, ' пропускает ход');
        2:
          Writeln('Игрок ', i, ' теряет ', -CurrScore[i],
            ' очков: такого слова не существует');
        3:
          Writeln('Игрок ', i, ' теряет ', -CurrScore[i],
            ' очков: это слово уже использовалось');
        4:
          Writeln('Игрок ', i, ' теряет ', -CurrScore[i],
            ' очков: это изначальное слово');
        5:
          Writeln('Игрок ', i, ' теряет ', -CurrScore[i],
            ' очков: слово содержит неправильные буквы: ', S);
      end;
      if i < PlayerCount then
        Inc(i)
      else
      begin
        i := 1;
        Write('Очки: ');
        for j := 1 to PlayerCount do
          Write(Score[j], ' ');
        Writeln;
      end
    end;
  until (CurrScore[1] = 0) and (CurrScore[2] = 0) and (CurrScore[3] = 0) and
    (CurrScore[4] = 0);
  Max := 0;
  for i := 1 to PlayerCount do
    if Score[i] > Max then
      Max := Score[i];
  for i := 1 to PlayerCount do
    if Score[i] = Max then
      Writeln('Игрок ', i, ' победил!');}
end;

procedure TForm1.Frame11Button1Click(Sender: TObject);
begin
  GameFrame1.Visible := True;
  Frame11.Visible := False;
  GameStart;
end;

procedure TForm1.Frame11Button2Click(Sender: TObject);
begin
  GameFrame1.Visible := True;
  Frame11.Visible := False;
  GameStart;
end;

procedure TForm1.Frame11Button3Click(Sender: TObject);
begin
  GameFrame1.Visible := True;
  Frame11.Visible := False;
  GameStart;
end;

procedure TForm1.Frame11Button4Click(Sender: TObject);
begin
  Frame21.Visible := True;
  Frame11.Visible := False;
end;

procedure TForm1.Frame21Button1Click(Sender: TObject);
begin
  Frame11.Visible := True;
  Frame21.Visible := False;
end;

procedure TForm1.Frame21Button2Click(Sender: TObject);
begin
  Frame31.Visible := True;
  Frame21.Visible := False;
end;

procedure TForm1.Frame31Button2Click(Sender: TObject);
begin
  Frame21.Visible := True;
  Frame31.Visible := False;
end;

end.
